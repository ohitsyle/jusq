// src/admin/components/Logs/LogsList.jsx
// FIXED: Using correct endpoint /admin/event-logs instead of /event-logs
import React, { useState, useEffect } from 'react';
import api from '../../services/api';
import SearchBar from '../common/SearchBar';
import ExportButton from '../common/ExportButton';
import StatusFilter from '../common/StatusFilter';
import DateRangeFilter from '../common/DateRangeFilter';
import { exportToCSV, prepareDataForExport} from '../../utils/csvExport';

export default function LogsList() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [severityFilter, setSeverityFilter] = useState('');
  const [typeFilter, setTypeFilter] = useState('');
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');

  const loadLogs = async () => {
    try {
      // FIXED: Changed from '/event-logs' to '/admin/event-logs'
      const data = await api.get('/admin/event-logs');
      setLogs(data || []);
      setLoading(false);
    } catch (error) {
      console.error('Error loading logs:', error);
      setLoading(false);
    }
  };

  useEffect(() => {
    loadLogs();
    const interval = setInterval(loadLogs, 5000);
    return () => clearInterval(interval);
  }, []);

  const handleExport = () => {
    const dataToExport = prepareDataForExport(filteredLogs);
    exportToCSV(dataToExport, 'event-logs');
  };

  const filteredLogs = logs.filter(log => {
    // Search filter
    if (searchQuery) {
      const searchLower = searchQuery.toLowerCase();
      const matchesSearch = (
        log.eventType?.toLowerCase().includes(searchLower) ||
        log.type?.toLowerCase().includes(searchLower) ||
        log.title?.toLowerCase().includes(searchLower) ||
        log.description?.toLowerCase().includes(searchLower) ||
        log.message?.toLowerCase().includes(searchLower) ||
        log.severity?.toLowerCase().includes(searchLower) ||
        new Date(log.timestamp).toLocaleString().toLowerCase().includes(searchLower)
      );
      if (!matchesSearch) return false;
    }

    // Severity filter
    if (severityFilter && log.severity !== severityFilter) return false;

    // Type filter
    if (typeFilter && (log.eventType || log.type) !== typeFilter) return false;

    // Date range filter
    if (startDate || endDate) {
      const logDate = new Date(log.timestamp);
      if (startDate && logDate < new Date(startDate)) return false;
      if (endDate && logDate > new Date(endDate + 'T23:59:59')) return false;
    }

    return true;
  });

  if (loading) {
    return <div style={{ textAlign: 'center', padding: '60px', color: '#FFD41C' }}>Loading logs...</div>;
  }

  return (
    <div>
      <div style={{ marginBottom: '30px', borderBottom: '2px solid rgba(255,212,28,0.2)', paddingBottom: '20px' }}>
        <div style={{ marginBottom: '20px' }}>
          <h2 style={{ fontSize: '24px', fontWeight: 700, color: '#FFD41C', margin: '0 0 8px 0', display: 'flex', alignItems: 'center', gap: '10px' }}>
            <span>üìã</span> System Event Logs
          </h2>
          <p style={{ fontSize: '13px', color: 'rgba(251,251,251,0.6)', margin: 0 }}>
            {searchQuery ? `Showing: ${filteredLogs.length} of ${logs.length}` : `Track all system activities ‚Ä¢ Total: ${logs.length}`}
          </p>
        </div>
        <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end', flexWrap: 'wrap' }}>
          <SearchBar
            value={searchQuery}
            onChange={setSearchQuery}
            placeholder="Search by type, title, description, or severity..."
          />
          <StatusFilter
            value={severityFilter}
            onChange={setSeverityFilter}
            label="Severity"
            options={[
              { value: 'info', label: 'Info' },
              { value: 'warning', label: 'Warning' },
              { value: 'error', label: 'Error' }
            ]}
          />
          <StatusFilter
            value={typeFilter}
            onChange={setTypeFilter}
            label="Type"
            options={[
              { value: 'admin_action', label: 'Admin Action' },
              { value: 'system_event', label: 'System Event' },
              { value: 'user_action', label: 'User Action' }
            ]}
          />
          <DateRangeFilter
            startDate={startDate}
            endDate={endDate}
            onStartChange={setStartDate}
            onEndChange={setEndDate}
          />
          <ExportButton onClick={handleExport} disabled={filteredLogs.length === 0} />
        </div>
      </div>

      {logs.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '60px', color: 'rgba(251,251,251,0.5)' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
          <div>No logs found</div>
        </div>
      ) : filteredLogs.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '60px', color: 'rgba(251,251,251,0.5)' }}>
          <div style={{ fontSize: '48px', marginBottom: '16px' }}>üîç</div>
          <div style={{ marginBottom: '12px' }}>No logs match your search</div>
          <button onClick={() => setSearchQuery('')} style={{
            padding: '8px 16px',
            background: 'rgba(255,212,28,0.15)',
            border: '2px solid rgba(255,212,28,0.3)',
            borderRadius: '8px',
            color: '#FFD41C',
            fontSize: '13px',
            fontWeight: 600,
            cursor: 'pointer'
          }}>
            Clear Search
          </button>
        </div>
      ) : (
        <div style={{ overflowX: 'auto', borderRadius: '12px', border: '1px solid rgba(255,212,28,0.2)' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
            <thead>
              <tr style={{ background: 'rgba(255,212,28,0.1)' }}>
                <th style={{ textAlign: 'left', padding: '16px', fontSize: '11px', fontWeight: 800, color: '#FFD41C', textTransform: 'uppercase', borderBottom: '2px solid rgba(255,212,28,0.3)' }}>Timestamp</th>
                <th style={{ textAlign: 'left', padding: '16px', fontSize: '11px', fontWeight: 800, color: '#FFD41C', textTransform: 'uppercase', borderBottom: '2px solid rgba(255,212,28,0.3)' }}>Type</th>
                <th style={{ textAlign: 'left', padding: '16px', fontSize: '11px', fontWeight: 800, color: '#FFD41C', textTransform: 'uppercase', borderBottom: '2px solid rgba(255,212,28,0.3)' }}>Title</th>
                <th style={{ textAlign: 'left', padding: '16px', fontSize: '11px', fontWeight: 800, color: '#FFD41C', textTransform: 'uppercase', borderBottom: '2px solid rgba(255,212,28,0.3)' }}>Description</th>
                <th style={{ textAlign: 'left', padding: '16px', fontSize: '11px', fontWeight: 800, color: '#FFD41C', textTransform: 'uppercase', borderBottom: '2px solid rgba(255,212,28,0.3)' }}>Severity</th>
              </tr>
            </thead>
            <tbody>
              {filteredLogs.slice(0, 100).map((log, index) => (
                <tr key={log._id || index} style={{ borderBottom: '1px solid rgba(255,212,28,0.1)' }}>
                  <td style={{ padding: '16px', color: 'rgba(251,251,251,0.9)' }}>
                    {new Date(log.timestamp).toLocaleString()}
                  </td>
                  <td style={{ padding: '16px' }}>
                    <span style={{
                      display: 'inline-block',
                      padding: '4px 12px',
                      borderRadius: '20px',
                      fontSize: '10px',
                      fontWeight: 700,
                      textTransform: 'uppercase',
                      background: log.eventType === 'admin_action' ? 'rgba(59,130,246,0.2)' : 'rgba(168,85,247,0.2)',
                      color: log.eventType === 'admin_action' ? '#3B82F6' : '#A855F7',
                      border: `1px solid ${log.eventType === 'admin_action' ? 'rgba(59,130,246,0.3)' : 'rgba(168,85,247,0.3)'}`,
                    }}>
                      {log.eventType || log.type}
                    </span>
                  </td>
                  <td style={{ padding: '16px', color: 'rgba(251,251,251,0.9)', fontWeight: 600 }}>
                    {log.title || 'N/A'}
                  </td>
                  <td style={{ padding: '16px', color: 'rgba(251,251,251,0.7)' }}>
                    {log.description || log.message || 'N/A'}
                  </td>
                  <td style={{ padding: '16px' }}>
                    <span style={{
                      display: 'inline-block',
                      padding: '4px 12px',
                      borderRadius: '20px',
                      fontSize: '10px',
                      fontWeight: 700,
                      textTransform: 'uppercase',
                      background: log.severity === 'warning' ? 'rgba(251,191,36,0.2)' : 
                                  log.severity === 'error' ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)',
                      color: log.severity === 'warning' ? '#FBBF24' : 
                             log.severity === 'error' ? '#EF4444' : '#22C55E',
                    }}>
                      {log.severity || 'info'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}